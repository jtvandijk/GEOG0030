# Spatial Models 
Last week, we explored spatial dependency and methods for measuring it. This week, we will examine how spatial autocorrelation can impact our analyses, especially in models where independence assumptions are crucial. To address these dependencies, we will use the `GWmodel` library to calculate local summary statistics for geographical areas and to fit basic spatially explicit models to our data.

## Lecture slides 
You can download the slides of this week's lecture here: [[Link]]({{< var slides.week05 >}}).

## Reading list
#### Essential readings {.unnumbered}
- Harris, R. 2019. **Chapter 8**: *Not just nuisance: Spatialising social statistics.* In: Whitworth, A. (ed). Towards a Spatial Social Policy: Bridging the Gap Between Geography and Social Policy. Bristol: Policy Press. [[Link]](https://www-jstor-org.libproxy.ucl.ac.uk/stable/j.ctvs1g92b.12?socuuid=53116c87-882d-4070-b1dc-45854bbedbfe)

#### Suggested readings {.unnumbered}
- Brundson, C., Fotheringham, M., and Charlton, M. 2002. Geographically Weighted Regression. *Journal of the Royal Statistical Society: Series D (The Statistician)* 47(3): 431-443. [[Link]](https://doi.org/10.1111/1467-9884.00145)
- Comber, A., Brundson, C., Charlton, M. *et al.*. 2022. A route map for successful applications of Geographically Weighted Regression. *Geographical Analysis* 55(1): 155-178. [[Link]](https://doi.org/10.1111/gean.12316)

## Elections results in England and Wales
This week we will investigate the political geography of England and Wales, focusing on the results of the July 2024 General Election, which was won by the Labour Party led by Keir Starmer. You will work with data extracted from two data sources: the [constituency results from the election](https://commonslibrary.parliament.uk/research-briefings/cbp-10009/) and socio-demographic information relating to age groups, economic status, and ethnic background from the 2021 Census, extracted using the [Custom Dataset Tool](https://www.ons.gov.uk/datasets/create). These datasets have been prepared and merged. Along with this dataset, we also have access to a `GeoPackage` that contains the boundaries of the parliamentary constituencies. 

You can download both files below and save them in your project folder under `data/attributes` and `data/spatial`, respectively.

| File                                                        | Type   | Link |
| :------                                                     | :------| :------ |
| England and Wales Parliamentary Constituencies GE2024       | `csv` | [Download](https://github.com/jtvandijk/GEOG0030/tree/master/data/attributes/England-Wales-GE2024-Constituency-Vars.csv) |
| England and Wales Parliamentary Constituencies Boundaries   | `GeoPackage` | [Download](https://github.com/jtvandijk/GEOG0030/tree/master/data/spatial/England-Wales-GE2024-Boundaries.gpkg) |

Open a new script within your `GEOG0030` project and save this as `w05-election-analysis.r`. 

Begin by loading the necessary libraries:

```{r}
#| label: 05-load-libraries
#| classes: styled-output
#| echo: True
#| eval: True
#| output: False
#| tidy: True
#| filename: "R code"
# load libraries
library(tidyverse)
library(sf)
library(tmap)
library(GWmodel)
```

::: {.callout-warning}
You may have to install some of these libraries if you have not used these before.
:::

Once downloaded, we can load both files into memory:
```{r}
#| label: 5-load-gpkg-csv
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: 'R code'
# load election dataset
elec_24 <- read_csv('data/attributes/England-Wales-GE2024-Constituency-Vars.csv')

# load constituency boundaries
cons_24 <- st_read('data/spatial/England-Wales-GE2024-Boundaries.gpkg')

# inspect
head(elec_24)

# inspect
head(cons_24)
``` 

::: {.callout-note}
You can inspect both objects using the `View()` function. 
:::

### Geographically weighted statistics
In [GEOG0018 Research Methods in Human Geography](https://jtvandijk.github.io/GEOG0018/03-statistics2.html), we already worked with this electoral dataset and we hypothesised that predominantly older voters tend to support the Conservative Party. To explore this, we examined the relationship between the proportion of individuals over 50 years old in each parliamentary constituency (`aged_50_years_and_over`) and the proportion of votes cast for the Conservative Party (`conservative_vote_share`). A scatterplot revealed an apparent association between these two variables, suggesting a possible link between age demographics and Conservative voting patterns.

```{r}
#| label: fig-05-plot-data-scatter
#| fig-cap: Quick scatterplot
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# scatterplot
plot(elec_24$aged_50_years_and_over, elec_24$conservative_vote_share, xlab = 'Proportion of population over 50 years old', ylab = 'Proportion of votes for the Conservative party')
```

However, as you should know by now, the first step when working with spatial data is to create a map:

```{r tidy='styler'} 
#| label: fig-05-map-vote-share
#| fig-cap: Proportions of votes cast for the Conservative party in the 2024 elections.
#| classes: styled-output
#| echo: True
#| eval: True
#| cache: True
#| filename: 'R code'
# join attribute data onto spatial data
cons_24 <- cons_24 |> 
  left_join(elec_24, by = c('pcon24cd' = 'constituency_code'))

# shape, polygons
tm_shape(cons_24) +
  
  # specify column, colours
  tm_fill(
    col = 'conservative_vote_share',
    style = 'jenks',
    n = '5',
    palette = c('#f1eef6', '#bdc9e1', '#74a9cf', '#2b8cbe', '#045a8d'),
    title = 'Vote share'
  ) +
  
  # set layout
  tm_layout(
    legend.outside = FALSE,
    legend.position = c('left', 'top'),
    frame = FALSE
  )
``` 

```{r tidy='styler'} 
#| label: fig-05-map-over-50-share
#| fig-cap: Proportions of population over 50 years old.
#| classes: styled-output
#| echo: True
#| eval: True
#| cache: True
#| filename: 'R code'
# shape, polygons
tm_shape(cons_24) +
  
  # specify column, colours
  tm_fill(
    col = 'aged_50_years_and_over',
    style = 'jenks',
    n = '5',
    palette = c('#f0f0f0', '#d9d9d9', '#bdbdbd', '#969696', '#737373'),
    title = 'Over 50 share'
  ) +
  
  # set layout
  tm_layout(
    legend.outside = FALSE,
    legend.position = c('left', 'top'),
    frame = FALSE
  )
``` 

### Geographically weighted regression
Geographically weighted regression (GWR) is used when the relationship between the dependent and independent variables is not constant across space, meaning the model coefficients vary by location. This is useful when you suspect that the relationship between variables may change depending on the geographic context. GWR provides a localised understanding of the relationships by allowing each observation to have its own set of regression coefficients, which can provide insights into how relationships differ across the study area. 

GWR fits a separate regression equation at each location in the study area, weighting nearby observations more heavily than those farther away. The weighting is typically based on a kernel function. The basic GWR equation is:

$$
y_{i} = \beta_{0}(\upsilon_{i}, v_{i}) + \sum_{k=1}^{p}\beta_{k}(\upsilon_{i}, v_{i})x_{ik} + \epsilon_{i}
$$

where $(\upsilon_{i}, v_{i})$ are the coordinates of location $i$ and $\beta_{k}(\upsilon_{i}, v_{i})$ are the location-specific coefficients. The geographically weighted correlation that we calculated is therefore essentially a univariate GWR.

### Spatial models
We have looked at geographically weighted statistics, including geographically weighted correlation and regression. However, whilst out of the scope of this module, there are many other approaches to account for space in statistical models. Examples of such models are the spatial error model and the spatial lag model.

#### Spatial error model
The spatial error model is used when the error terms in a regression model exhibit spatial autocorrelation, meaning the error terms are not independent across space. This can happen due to omitted variables that have a spatial pattern or unmeasured factors that affect the dependent variable similarly across nearby locations.

The model adjusts for spatial autocorrelation by adding a spatially lagged error term (a weighted sum of the errors from neighbouring locations) to the regression equation:

$$
y = X\beta + \upsilon, \upsilon = \lambda W \upsilon + \epsilon
$$

where $X\beta$ represents the standard regression components, $\lambda$ is a spatial autoregressive parameter, $W$ is a spatial weights matrix, and $\upsilon$ is a vector of spatially autocorrelated errors.

::: {.callout-note}
Spatial error models can be fitted using R’s [spatialreg](https://cran.r-project.org/web/packages/spatialreg/index.html) package.
:::

#### Spatial lag model
The spatial lag model is appropriate when the dependent variable itself exhibits spatial dependence. This means the value of the dependent variable in one location depends on the values in neighbouring locations. This model is used to capture the spillover effects or diffusion processes, where the outcome in one area is influenced by outcomes in nearby areas (e.g. house prices, crime rates).

The model incorporates a spatially lagged dependent variable, which is the weighted sum of the dependent variable values in neighbouring locations, into the regression equation:

$$
y = \rho Wy + X\beta + \epsilon
$$

where $\rho$ is the spatial autoregressive coefficient, $Wy$ represents the spatially lagged dependent variable, and $X\beta$ represents the standard regression components.

::: {.callout-note}
Spatial lag models can be fitted using R’s [spatialreg](https://cran.r-project.org/web/packages/spatialreg/index.html) package.
:::

#### To note
The spatial error model adjusts for spatial autocorrelation in the error terms, whereas the spatial lag model adjusts for spatial dependence in the dependent variable itself. The spatial error model does not alter the interpretation of the coefficients of the independent variables, while the spatial lag model introduces a feedback loop where changes in one area can influence neighbouring areas.

Both the spatial error and spatial lag models assume that the relationships between variables are the same across the study area, with adjustments made only for spatial dependencies. GWR, on the other hand, allows the relationships themselves to vary across space. GWR is more flexible but also more complex and computationally intensive, providing local instead of global estimates of coefficients.

## Assignment

## Before you leave

