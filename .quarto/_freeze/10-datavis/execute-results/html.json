{
  "hash": "badc7325ae97d056d3a17607134747c7",
  "result": {
    "markdown": "# Complex Visualisations\nMost of the visualisations we have created over the past weeks have been maps. However, you will often need to use other types of visualisations for your data, such as histograms, scatterplots, dendrograms, and boxplots. While `base` R can be used for simple visualisations, it is best suited for quick data inspections. For publication-worthy and more complex visualisations, the `ggplot2` library, which we used last week to create bivariate maps, offers a unified and effective approach to data visualisation based on the grammar of graphics. \n\n## Lecture slides\nYou can download the slides of this week's lecture here: [[Link]]({{< var slides.week10 >}}).\n\n## Reading list\n#### Essential readings {.unnumbered}\n- Wickham, H. 2010. A layered grammar of graphics. *Journal of Computational and Graphical Statistics* 19(1): 3-28. [[Link]](https://doi.org/10.1198/jcgs.2009.07098)\n\n#### Suggested readings {.unnumbered}\n- Cheshire, J. and Uberti, O. 2014. *London, The Information Capital: 100 Maps & Graphics That Will Change How You View the City.* London: Particular Books.\n- Wickham, H., Çetinkaya-Rundel, M., and Grolemund, G. *R for Data Science*. 2nd edition. **Chapter 3: Data visualisation**. [[Link]](https://r4ds.had.co.nz/data-visualisation.html)\n\n## Population groups in London\nToday, we will use the same dataset that we used in [Week 8](07-geodemographics.html) on self-identified ethnicity. We will visualise the distribution of the self-identified White-British population across the 12 Inner London Boroughs. The LSOA data covers all usual residents, as recorded in the 2021 Census for England and Wales, aggregated at the Lower Super Output Area (LSOA) level. A copy of the 2021 London LSOAs spatial boundaries is also available. If you do not already have it on your computer, save these file in your `data/attribues` and `data/spatial` folders.\n\n| File                                        | Type   | Link |\n| :------                                     | :------| :------ |\n| London LSOA Census 2021 Ethnicity           | `csv` | [Download](https://github.com/jtvandijk/GEOG0030/tree/master/data/attributes/London-LSOA-Ethnicity.csv) | \n| London LSOA 2021 Spatial Boundaries         | `GeoPackage` | [Download](https://github.com/jtvandijk/GEOG0030/raw/refs/heads/main/data/spatial/London-LSOA-2021.gpkg) |\n\nTo get started, let us create our first script. **File** -> **New File** -> **R Script**. Save your script as `w10-ethnicity-london.r`. \n\nWe will start by loading the libraries that we will need:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# load libraries\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(janitor)\nlibrary(treemapify)\n```\n:::\n\n\n::: {.callout-warning}\nYou may have to install some of these libraries if you have not used these before.\n:::\n\nOnce downloaded, we can load the files in the usual fashion:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# load attribute dataset\nlsoa_eth <- read_csv(\"data/attributes/London-LSOA-Ethnicity.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRows: 99880 Columns: 5\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (3): Lower layer Super Output Areas Code, Lower layer Super Output Areas...\ndbl (2): Ethnic group (20 categories) Code, Observation\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n\n```{.r .cell-code}\n# load spatial dataset\nlsoa21 <- st_read(\"data/spatial/London-LSOA-2021.gpkg\") |>\n    st_drop_geometry()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `London-LSOA-2021' from data source \n  `/Users/justinvandijk/Library/CloudStorage/Dropbox/UCL/Web/jtvandijk.github.io/GEOG0030/data/spatial/London-LSOA-2021.gpkg' \n  using driver `GPKG'\nSimple feature collection with 4994 features and 8 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 503574.2 ymin: 155850.8 xmax: 561956.7 ymax: 200933.6\nProjected CRS: OSGB36 / British National Grid\n```\n:::\n\n```{.r .cell-code}\n# inspect\nhead(lsoa_eth)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  Lower layer Super Output Areas…¹ Lower layer Super Ou…² Ethnic group (20 cat…³\n  <chr>                            <chr>                                   <dbl>\n1 E01000001                        City of London 001A                        -8\n2 E01000001                        City of London 001A                         1\n3 E01000001                        City of London 001A                         2\n4 E01000001                        City of London 001A                         3\n5 E01000001                        City of London 001A                         4\n6 E01000001                        City of London 001A                         5\n# ℹ abbreviated names: ¹​`Lower layer Super Output Areas Code`,\n#   ²​`Lower layer Super Output Areas`, ³​`Ethnic group (20 categories) Code`\n# ℹ 2 more variables: `Ethnic group (20 categories)` <chr>, Observation <dbl>\n```\n:::\n\n```{.r .cell-code}\n# inspect\nhead(lsoa21)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   lsoa21cd                  lsoa21nm  bng_e  bng_n      long      lat\n1 E01000001       City of London 001A 532123 181632 -0.097140 51.51816\n2 E01000002       City of London 001B 532480 181715 -0.091970 51.51882\n3 E01000003       City of London 001C 532239 182033 -0.095320 51.52174\n4 E01000005       City of London 001E 533581 181283 -0.076270 51.51468\n5 E01000006 Barking and Dagenham 016A 544994 184274  0.089317 51.53875\n6 E01000007 Barking and Dagenham 015A 544187 184455  0.077763 51.54058\n                                globalid pop2021\n1 {1A259A13-A525-4858-9CB0-E4952BA01AF6}    1473\n2 {1233E433-0B0D-4807-8117-17A83C23960D}    1384\n3 {5163B7CB-4FFE-4F41-95B9-AA6CFC0508A3}    1613\n4 {2AF8015E-386E-456D-A45A-D0A223C340DF}    1101\n5 {B492B45E-175E-4E77-B0B5-5B2FD6993EF4}    1842\n6 {4A374975-B1D0-40CE-BF6E-6305623E5F7E}    2904\n```\n:::\n:::\n\n\n::: {.callout-note}\nYou can further inspect both objects using the `View()` function. \n:::\n\nWe will start by pivoting the data and transforming the raw counts into proportions:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# prepare ethnicity data\nlsoa_eth <- lsoa_eth |>\n    clean_names() |>\n    pivot_wider(id_cols = \"lower_layer_super_output_areas_code\", names_from = \"ethnic_group_20_categories\",\n        values_from = \"observation\") |>\n    clean_names()\n\n# proportions, select columns\nlsoa_eth <- lsoa_eth |>\n    rowwise() |>\n    mutate(eth_pop = sum(across(2:21))) |>\n    mutate(across(2:21, ~./eth_pop)) |>\n    select(-2)\n\n# inspect\nlsoa_eth\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4,994 × 21\n# Rowwise: \n   lower_layer_super_output_area…¹ asian_asian_british_…² asian_asian_british_…³\n   <chr>                                            <dbl>                  <dbl>\n 1 E01000001                                      0.00271                0.0448 \n 2 E01000002                                      0.00505                0.0736 \n 3 E01000003                                      0.00682                0.0323 \n 4 E01000005                                      0.239                  0.0318 \n 5 E01000006                                      0.116                  0.00596\n 6 E01000007                                      0.113                  0.0148 \n 7 E01000008                                      0.110                  0.00445\n 8 E01000009                                      0.119                  0.0122 \n 9 E01000011                                      0.146                  0.00469\n10 E01000012                                      0.122                  0.00298\n# ℹ 4,984 more rows\n# ℹ abbreviated names: ¹​lower_layer_super_output_areas_code,\n#   ²​asian_asian_british_or_asian_welsh_bangladeshi,\n#   ³​asian_asian_british_or_asian_welsh_chinese\n# ℹ 18 more variables: asian_asian_british_or_asian_welsh_indian <dbl>,\n#   asian_asian_british_or_asian_welsh_pakistani <dbl>,\n#   asian_asian_british_or_asian_welsh_other_asian <dbl>, …\n```\n:::\n:::\n\n\n::: {.callout-note}\nIf your `clean_names()` function returns an error, it is likely due to a conflict with another library that also includes a `clean_names()` function. In such cases, R cannot determine which one to use. To resolve this, you can specify the library explicitly by using `janitor::clean_names()`.\n:::\n\nThe column names are rather long, so let's rename these manually:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# rename columns\nnames(lsoa_eth)[2:20] <- c(\"Asian - Bangladeshi\", \"Asian - Chinese\", \"Asian - Indian\",\n    \"Asian - Pakistani\", \"Asian - Other\", \"Black - African\", \"Black - Caribbean\",\n    \"Black - Other\", \"Mixed - Asian\", \"Mixed - Black African\", \"Mixed - Black Carribean\",\n    \"Mixed - Other\", \"White - British\", \"White - Irish\", \"White - Traveller\", \"White - Roma\",\n    \"White - Other\", \"Arab - Other\", \"Any Other Group\")\n```\n:::\n\n\nThe last thing we need to do is extract the LSOAs that fall within the 12 Inner London Boroughs. We can do this by using the LSOA names that are inside the spatial dataframe:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# boroughs\ninner_boroughs <- c(\"Camden\", \"Greenwich\", \"Hackney\", \"Hammersmith and Fulham\", \"Islington\", \"Kensington and Chelsea\", \"Lambeth\", \"Lewisham\", \"Southwark\", \"Tower Hamlets\", \"Wandsworth\", \"Westminster\")\n\n# filter spatial data\nlsoa21_inner <- lsoa21 |>\n  filter(str_detect(lsoa21nm, paste(inner_boroughs, collapse = \"|\")))\n\n# filter attribute data, add lsoa names\nlsoa_eth <- lsoa_eth |>\n  filter(lower_layer_super_output_areas_code %in% lsoa21_inner$lsoa21cd)\n\n# add lsoa names\nlsoa_eth <- lsoa_eth |>\n  left_join(lsoa21[1:2], by = c(\"lower_layer_super_output_areas_code\" = \"lsoa21cd\"))\n\n# inspect\nlsoa_eth\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1,792 × 22\n# Rowwise: \n   lower_layer_super_output_areas_code `Asian - Bangladeshi` `Asian - Chinese`\n   <chr>                                               <dbl>             <dbl>\n 1 E01000842                                         0.00209            0.0265\n 2 E01000843                                         0.00167            0.0301\n 3 E01000844                                         0.00614            0.0258\n 4 E01000845                                         0.0193             0.0273\n 5 E01000846                                         0.0586             0.0179\n 6 E01000847                                         0.0506             0.0312\n 7 E01000848                                         0.00269            0.0249\n 8 E01000849                                         0.0125             0.0249\n 9 E01000850                                         0.0218             0.113 \n10 E01000851                                         0.0216             0.0824\n# ℹ 1,782 more rows\n# ℹ 19 more variables: `Asian - Indian` <dbl>, `Asian - Pakistani` <dbl>,\n#   `Asian - Other` <dbl>, `Black - African` <dbl>, `Black - Caribbean` <dbl>,\n#   `Black - Other` <dbl>, `Mixed - Asian` <dbl>,\n#   `Mixed - Black African` <dbl>, `Mixed - Black Carribean` <dbl>,\n#   `Mixed - Other` <dbl>, `White - British` <dbl>, `White - Irish` <dbl>,\n#   `White - Traveller` <dbl>, `White - Roma` <dbl>, `White - Other` <dbl>, …\n```\n:::\n:::\n\n\n::: {.callout-tip}\nIf you want to know what the `paste(inner_boroughs, collapse = '|')` code does, you can run it separately in the console to find out.\n:::\n\n### Building boxplots\nThe ggplot2 library is built [on the layered grammar of graphics](https://www.tandfonline.com/doi/abs/10.1198/jcgs.2009.07098), which provides a structured approach to creating visualisations. This means that plots are constructed by adding layers, such as data, aesthetic mappings (e.g., axes, colours, sizes), geometric shapes (e.g., points, lines, bars), and optional elements like themes or statistical transformations. This modular design allows users to build complex and customisable plots step by step, ensuring flexibility and clarity in the visualisation process.\n\nLet's try to use this approach by making a boxplot on the distribution of people that self-identify as White British across all Inner London Boroughs. With `ggplot2`, every plot begins with the `ggplot()` function, which creates a coordinate system to which layers can be added. The first argument of `ggplot()` specifies the dataset to use:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lsoa_eth)\n```\n:::\n\n\nTo build your graph, you add one or more layers to `ggplot()`. For instance, `geom_point()` adds a layer of points to create a scatterplot. `ggplot2` provides many geom functions, each adding a different type of layer to your plot. To create a boxplot, you add the `geom_boxplot()` layer. For boxplots, the `mapping` argument defines how dataset variables are linked to visual properties, such as the grouping or value axes. The mapping is paired with `aes()`, where `y` specifies the numeric variable:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`)) +\n  # add geometry\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![Basic boxplot using `ggplot2`.](10-datavis_files/figure-html/fig-10-boxplot-basic-1.png){#fig-10-boxplot-basic width=672}\n:::\n:::\n\n\n::: {.callout-tip}\nAn aesthetic is a visual property of the elements in your plot. Aesthetics include attributes like size, shape, or colour of points. By modifying the values of these aesthetic properties, you can display a point in various ways, allowing for greater customisation and clarity in your visualisation.\n:::\n\nJust like with `tmap`, we can customise the basic plot by styling the boxplot, adding labels, and adjusting its overall appearancs:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`)) +\n  # add geometry\n  geom_boxplot(\n    fill = \"#f0f0f0\",\n    color = \"#252525\",\n    outlier.color = \"#ef3b2c\",\n    linewidth = 0.5,\n    staplewidth = 0.5,\n    outlier.shape = 16,\n    outlier.size = 2\n  ) +\n  # add labels\n  labs(\n    title = \"Population self-identifying as White British\",\n    x = \"\"\n  ) +\n  # set basic theme\n  theme_light() +\n  # customise theme\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 14),\n    axis.title = element_text(size = 12, colour = \"#34495e\"),\n    axis.text = element_text(size = 10, colour = \"#34495e\"),\n    axis.text.y = element_blank(),\n    axis.title.x = element_blank(),\n    panel.grid.major = element_line(linewidth = 0.5, colour = \"#969696\"),\n    panel.grid.minor = element_line(linewidth = 0.2, colour = \"#d9d9d9\")\n  )\n```\n\n::: {.cell-output-display}\n![Stylised boxplot using `ggplot2`.](10-datavis_files/figure-html/fig-10-boxplot-pretty-1.png){#fig-10-boxplot-pretty width=672}\n:::\n:::\n\n\nBut what if we wwant to create a boxplot for all Inner London Boroughs? We can do this by adding a grouping variable:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# add borough names\nlsoa_eth <- lsoa_eth |>\n  mutate(borough_name = substr(lsoa21nm, 1, nchar(lsoa21nm) - 5))\n\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`, y = borough_name)) +\n  # add geometry\n  geom_boxplot(\n    fill = \"#f0f0f0\",\n    color = \"#252525\",\n    outlier.color = \"#ef3b2c\",\n    linewidth = 0.5,\n    staplewidth = 0.5,\n    utlier.shape = 16,\n    outlier.size = 2\n  ) +\n  # add labels\n  labs(\n    title = \"Population self-identifying as White British\",\n    y = \"Borough\",\n    x = \"\"\n  ) +\n  # set basic theme\n  theme_light() +\n  # customise theme\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 14),\n    axis.title = element_text(size = 12, colour = \"#34495e\"),\n    axis.text = element_text(size = 10, colour = \"#34495e\"),\n    panel.grid.major = element_line(linewidth = 0.5, colour = \"#969696\"),\n    panel.grid.minor = element_line(linewidth = 0.2, colour = \"#d9d9d9\")\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_boxplot(fill = \"#f0f0f0\", color = \"#252525\", outlier.color =\n\"#ef3b2c\", : Ignoring unknown parameters: `utlier.shape`\n```\n:::\n\n::: {.cell-output-display}\n![Stylised boxplot using `ggplot2`.](10-datavis_files/figure-html/fig-10-boxplot-pretty-boroughs-1.png){#fig-10-boxplot-pretty-boroughs width=672}\n:::\n:::\n\n\nThe boroughs are drawn in alphabetical order by default. To change this we need to adjust the order by creating a factor. For instance, we can sort the boroughs by their median values.\n\n::: {.callout-note}\nIn R, a factor is a data structure used to represent categorical variables with a specific order or grouping. Factors allow you to define and manipulate the order of categories, which is especially useful for plotting or analysis.\n:::\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# median values\nlsoa_med <- lsoa_eth |>\n  group_by(borough_name) |>\n  summarise(median = median(`White - British`))\n\n# create factor\nlsoa_eth <- lsoa_eth |>\n  mutate(borough_name_factor = factor(borough_name, levels = lsoa_med$borough_name[order(lsoa_med$median, decreasing = TRUE)]))\n\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`, y = borough_name_factor)) +\n  # add geometry\n  geom_boxplot(\n    fill = \"#f0f0f0\",\n    color = \"#252525\",\n    outlier.color = \"#ef3b2c\",\n    linewidth = 0.5,\n    staplewidth = 0.5,\n    outlier.shape = 16,\n    outlier.size = 2\n  ) +\n  # add labels\n  labs(\n    title = \"Population self-identifying as White British\",\n    y = \"Borough\",\n    x = \"\"\n  ) +\n  # set basic theme\n  theme_light() +\n  # customise theme\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 14),\n    axis.title = element_text(size = 12, colour = \"#34495e\"),\n    axis.text = element_text(size = 10, colour = \"#34495e\"),\n    panel.grid.major = element_line(linewidth = 0.5, colour = \"#969696\"),\n    panel.grid.minor = element_line(linewidth = 0.2, colour = \"#d9d9d9\")\n  )\n```\n\n::: {.cell-output-display}\n![Stylised boxplot using `ggplot2`.](10-datavis_files/figure-html/fig-10-boxplot-pretty-boroughs-ordered-1.png){#fig-10-boxplot-pretty-boroughs-ordered width=672}\n:::\n:::\n\n\n### Creating panels\nBoxplots are effective for visualising distributions, but histograms offer another way to explore the same data by showing the frequency of values. While histograms cannot be displayed alongside boxplots in the same image, we can create a series of histograms, each displayed in a separate panel. These panels can show the distributions for different groups, such as individual boroughs.\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`)) +\n  # add geometry\n  geom_histogram() +\n  # create panels\n  facet_wrap(\n    ~borough_name,\n    ncol = 4,\n    nrow = 3\n  ) +\n  # add labels\n  labs(\n    title = \"Population self-identifying as White British\",\n    y = \"Number of LSOAs\",\n    x = \"\"\n  ) +\n  # set basic theme\n  theme_light() +\n  # customise theme\n  theme(\n    axis.title = element_text(size = 12, colour = \"#34495e\"),\n    axis.text = element_text(size = 10, colour = \"#34495e\"),\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![Histograms presented in individual panels.](10-datavis_files/figure-html/fig-10-histogram-panel-1.png){#fig-10-histogram-panel width=672}\n:::\n:::\n\n\nWe could use the same approach to create a series of scatterplots to show the relationship between two variables:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lsoa_eth, aes(x = `White - British`, y = `White - Other`)) +\n  # add geometry\n  geom_point() +\n  # create panels\n  facet_wrap(\n    ~borough_name,\n    ncol = 4,\n    nrow = 3\n  ) +\n  # set basic theme\n  theme_light() +\n  # customise theme\n  theme(\n    plot.title = element_text(hjust = 0.5, size = 14),\n    axis.title = element_text(size = 12, colour = \"#34495e\"),\n    axis.text = element_text(size = 10, colour = \"#34495e\"),\n  )\n```\n\n::: {.cell-output-display}\n![Scatterplots presented in individual panels.](10-datavis_files/figure-html/fig-10-scatter-panel-1.png){#fig-10-scatter-panel width=672}\n:::\n:::\n\n\n::: {.callout-tip}\nTo export a ggplot, first assign your plot to an object. Then, use the `ggsave()` function to save the plot to a file, specifying the desired filename and format (e.g. `.png` or `.pdf`). You can specify the dimensions of the output using the `width` and `height` arguments.\n:::\n\n### Making treemaps\nThe flexibility of `ggplot2` extends beyond traditional plots through additional libraries that expand its functionality, allowing you to create specialised visualisations. For instance, we can use the `treemapify` library to create a treemap. \n\n::: {.callout-note}\nA treemap is a data visualisation that displays hierarchical data as nested rectangles, with each rectangle representing a category or subcategory. The size of each rectangle is proportional to a specific variable, often reflecting values such as frequency or proportion, making it easier to compare the relative sizes of different elements. Treemaps are particularly useful for visualising large datasets with multiple categories or subcategories in a compact, space-efficient layout.\n:::\n\nLet's try to create a treemap of the mean share of different population groups in the borough of Lambeth. We first need to calculate the mean of each population group in Lambeth and then transform the data from a  [wide format](https://towardsdatascience.com/long-and-wide-formats-in-data-explained-e48d7c9a06cb) to a [long format](https://towardsdatascience.com/long-and-wide-formats-in-data-explained-e48d7c9a06cb) so that all proportions are in the same column.\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# mean group values lambeth\nlambeth_mean <- lsoa_eth |>\n    filter(borough_name == \"Lambeth\") |>\n    group_by(borough_name) |>\n    summarise(across(2:20, mean))\n\n# wide to long\nlambeth_mean <- lambeth_mean |>\n    pivot_longer(cols = 2:20, names_to = \"population_group\", values_to = \"proportion\")\n```\n:::\n\n\nWe can now visualise the share of each population group in Lambeth using a treemap:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = lambeth_mean, aes(area = proportion, fill = population_group, label = population_group)) +\n  # add geometry\n  geom_treemap() +\n  # add text\n  geom_treemap_text(\n    colour = \"white\",\n    place = \"centre\",\n    grow = TRUE,\n    min.size = 8\n  ) +\n  # set basic theme\n  theme_minimal() +\n  # customise theme\n  theme(\n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![Treemap of relative share of population groups in Lambeth.](10-datavis_files/figure-html/fig-10-treemap-1.png){#fig-10-treemap width=672}\n:::\n:::\n\n\nWe could create facets for these treemaps, but we can also use subgroups to create a nested representation of our data - weighted by the total population in each London borough.\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# mean group values london\nlondon_mean <- lsoa_eth |>\n    group_by(borough_name) |>\n    summarise(across(2:20, mean))\n\n# total group values london\nlondon_sum <- lsoa_eth |>\n    group_by(borough_name) |>\n    summarise(borough_population = sum(eth_pop))\n\n# wide to long,\nlondon_mean <- london_mean |>\n    pivot_longer(cols = 2:20, names_to = \"population_group\", values_to = \"proportion\")\n\n# add total population, weigh\nlondon_mean <- london_mean |>\n    left_join(london_sum, by = c(borough_name = \"borough_name\")) |>\n    mutate(proportion_weighted = proportion * borough_population)\n```\n:::\n\n\nNow the data have been prepared, we can create a treemap again as follows:\n\n\n::: {.cell .styled-output filename='R code'}\n\n```{.r .cell-code}\n# initiate ggplot\nggplot(data = london_mean, aes(area = proportion_weighted, fill = population_group, label = population_group, subgroup = borough_name)) +\n  # add geometry\n  geom_treemap() +\n  # add text\n  geom_treemap_text(\n    colour = \"#f0f0f0\",\n    place = \"centre\",\n    grow = TRUE,\n    min.size = 8,\n  ) +\n  # add border\n  geom_treemap_subgroup_border(\n    colour = \"#000000\"\n  ) +\n  # add text\n  geom_treemap_subgroup_text(\n    colour = \"#636363\",\n    place = \"bottomleft\",\n    size = 14,\n    fontface = \"bold\",\n    padding.x = grid::unit(2, \"mm\"),\n    padding.y = grid::unit(2, \"mm\"),\n  ) +\n  # set basic theme\n  theme_minimal() +\n  # customise theme\n  theme(\n    legend.position = \"none\",\n  )\n```\n\n::: {.cell-output-display}\n![Treemap of relative share of population groups in London, organised by borough](10-datavis_files/figure-html/fig-10-treemap-subgroups-1.png){#fig-10-treemap-subgroups width=672}\n:::\n:::\n\n\n## Assignment\nThe `ggplot2` library supports a wide variety of chart types, all based on the same core principles of layering elements such as data, aesthetics, and geometric shapes. So far, we have worked with boxplots, scatterplots, histograms, and treemaps. However, `ggplot2` also offers many other geometries, including spatial geometries, that you can use to create more diverse visualisations.\n\nUsing the `lsoa_eth` dataset try to to complete the following tasks:\n\n1. Create a [violin plot](https://ggplot2.tidyverse.org/reference/geom_violin.html): A violin plot combines aspects of a boxplot and a density plot, offering a compact view of the distribution of continuous data. Use the `geom_violin()` function to visualise the distribution of the self-identified *Asian Bangladeshi* population for each of the Inner London boroughs.\n2. Create a map: Use the `geom_sf()` function to map the distribution of the self-identified *Black Caribbean* population across Greater London.\n3. Create a faceted map: Create a faceted map showing the distribution of the self-identified *Asian Bangladeshi*, *Asian Chinese*, *Black African*, and *White British* populations across London.\n\n::: {.callout-tip}\nTo help you get familiar with ggplot2 and its principles, you can use the `esquisse` library, which allows you to [interactively create plots and generate the corresponding `ggplot2` code](https://dreamrs.github.io/esquisse/).\n:::\n\n## Before you leave \nThat is it for today, and indeed, [you have now reached the end of Geocomputation](https://www.youtube.com/watch?v=fFw7q-BLxLA)! Over the course of this module, we have explored the fundamental principles of spatial analysis, data visualisation, and reproducible research. It is now inevitable: time for that reading list.\n",
    "supporting": [
      "10-datavis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}