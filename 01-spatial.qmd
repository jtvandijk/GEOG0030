# R for Spatial Analysis
This week's lecture offered a comprehensive introduction to the Geocomputation module, highlighting how and why it differs from a traditional GIScience course. In this week's tutorial, we will introduce you to using R and RStudio for quantitative spatial data, focusing specifically on how R can be used to make maps.

## Lecture slides
You can download the slides of this week's lecture here: [[Link]]({{< var slides.week01 >}}).

## Reading list 
#### Essential readings {.unnumbered}
- Brundson, C. and Comber, A. 2020. Opening practice: Supporting reproducibility and critical spatial data science. *Journal of Geographical Systems* 23: 477–496. [[Link]](https://doi.org/10.1007/s10109-020-00334-2)
- Longley, P. *et al.* 2015. Geographic Information Science & Systems, **Chapter 1**: *Geographic Information: Science, Systems, and Society*, pp. 1-32. [[Link]](https://ucl.rl.talis.com/link?url=https%3A%2F%2Fapp.knovel.com%2Fhotlink%2Ftoc%2Fid%3AkpGISSE001%2Fgeographic-information-science%3Fkpromoter%3Dmarc&sig=e437927b963cc591dcb65491eccdd3869cc31aef80e1443cb2ba12d8f3bb031a)

#### Suggested readings {.unnumbered}
- Miller, H. and Goodchild, M. 2015. Data-driven geography. *GeoJournal* 80: 449–461. [[Link]](https://doi.org/10.1007/s10708-014-9602-6)
- Goodchild, M. 2009. Geographic information systems and science: Today and tomorrow. *Annals of GIS* 15(1): 3-9. [[Link]](https://doi.org/10.1080/19475680903250715)

## Europeans in London
In RStudio, scripts allow us to build and save code that can be run repeatedly. We can organise these scripts into [RStudio projects](https://support.posit.co/hc/en-us/articles/200526207-Using-RStudio-Projects), which consolidate all files related to an analysis such as input data, R scripts, results, figures, and more. This organisation helps keep track of all data, input, and output, while enabling us to create standalone scripts for each part of our analysis. Additionally, it simplifies managing [directories and filepaths](https://en.wikipedia.org/wiki/Path_(computing)) and allows us to keep track of our installed packages through [renv](https://rstudio.github.io/renv/articles/renv.html).

::: {.callout-note}
Package management in R involves handling the installation, updating, and tracking of external libraries needed for your code. This ensures that your R scripts can run smoothly without issues related to missing or incompatible packages. Within an RStudio project, you can use `renv` to create a reproducible environment by capturing the specific package versions used in the project. This means that anyone working on or revisiting the project will have access to the same package setup, preventing problems caused by package updates or changes. 
:::

Navigate to **File** -> **New Project** -> **New Directory**, and create a folder with the name `GEOG0030`. Tick the checkbox for *Use renv with this project* and click on **Create Project**. You should now see your main RStudio window switch to this new project and when you check your **files** pane, you should see a new **R Project** called `GEOG0030`.
  
::: {.callout-warning}
Please ensure that **folder names** and **file names** do not contain spaces or special characters such as `*` `.` `"` `/` `\` `[` `]` `:` `;` `|` `=` `,` `<` `?` `>` `&` `$` `#` `!` `'` `{` `}` `(` `)`. Different operating systems and programming languages deal differently with spaces and special characters and as such including these in your folder names and file names can cause many problems and unexpected errors. As an alternative to using white space you can use an underscore (`_`) or hyphen (`-`) if you like.
:::

With our project ready to go, today we will map the distribution of the share of European immigrants across London. The data covers the number of people in London that are born in a European country, as recorded in the 2021 Census for England and Wales, aggregated at the [Middle Layer Super Output Area (MSOA)](https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeographies/census2021geographies) level.

::: {.callout-note}
An MSOA is a geographic unit used in the UK for statistical analysis. It typically represents small areas with populations of around 5,000 to 15,000 people and is designed to ensure consistent data reporting. MSOAs are commonly used to report on census data, deprivation indices, and other socio-economic statistics.
:::

The dataset has been extracted using the [Custom Dataset Tool](https://www.ons.gov.uk/datasets/create), and you can download the file via the link provided below. Save the file in your project folder under `data/attributes`. Along with this dataset, we also have access to a `GeoPackage` that contains the MSOA boundaries. Save this file under `data/spatial`, respectively.

::: {.callout-note}
You will to have created a folder named `data` within your RStudio Project directory, inside which you will have to have a folder named `attributes` and a folder named `spatial`.
:::

| File                                        | Type   | Link |
| :------                                     | :------| :------ |
| London MSOA Census 2021 European Population | `csv` | [Download](https://github.com/jtvandijk/GEOG0030/tree/master/data/attributes/London-MSOA-European.csv) |
| London MSOA 2021 Spatial Boundaries         | `GeoPackage` | [Download](https://github.com/jtvandijk/GEOG0030/raw/refs/heads/main/data/spatial/London-MSOA-2021.gpkg) |

::: {.callout-tip}
To download a `csv` file that is hosted on GitHub, click on the `Download raw file` button on the top right of your screen and it should download directly to your computer.
:::

::: {.callout-note}
You may have used spatial data before and noticed that we did not download a collection of files known as a `shapefile` but a `GeoPackage` instead. Whilst `shapefiles` are still being used, `GeoPackage` is a more modern and portable file format. Have a look at this article on *towardsdatascience.com* for an excellent explanation on why one should use `GeoPackage` files over `shapefiles` where possible: [[Link]](https://towardsdatascience.com/why-you-need-to-use-geopackage-files-instead-of-shapefile-or-geojson-7cb24fe56416)
:::

To get started, let us create our first script. **File** -> **New File** -> **R Script**. Save your script as `w01-european-population-london.r`. 

We will start by loading the libraries that we will need:

```{r}
#| label: 01-load-libraries
#| classes: styled-output
#| echo: True
#| eval: True
#| output: False
#| tidy: True
#| filename: "R code"
# load libraries
library(tidyverse)
library(sf)
library(tmap)
```

::: {.callout-warning}
You may have to install some of these libraries if you have not used these before.
:::

::: {.callout-warning}
For Linux and macOS users who are new to working with spatial data in R, the installation of the `sf` library may fail because additional (non-R) libraries are required which are automatically installed for Windows users. If you encounter installation issues,, please refer to the [information pages](https://r-spatial.github.io/sf/#macos) of the `sf` library for instructions on how to install these additional libraries.
:::

Once downloaded, we can load both files into memory:
```{r}
#| label: 01-load-gpkg-csv
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: 'R code'
# read spatial dataset
msoa21 <- st_read('data/spatial/London-MSOA-2021.gpkg')

# load attribute dataset
msoa_eur <- read_csv('data/attributes/London-MSOA-European.csv')

# inspect
head(msoa21)

# inspect
head(msoa_eur)
``` 

::: {.callout-note}
You can further inspect both objects using the `View()` function. 
:::

### Exploring spatial data
The first thing we want to do when we load spatial data is to plot the data to check whether everything is in order. To do this, we can simply use the base R `plot()` function

```{r}
#| label: fig-01-plot-map-data
#| fig-cap: Quick plot to inspect the MSOA spatial data.
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| cache: True
#| filename: "R code"
# plot data
plot(msoa21, max.plot = 1)
``` 

You should see your `msoa21` plot appear in your **Plots** window.

::: {.callout-tip}
The `plot()` function should not to be used to make publishable maps but can be used as a quick way of inspecting your spatial data.
:::

Just as with a tabular dataframe, we can also inspect the attributes of the spatial data frame:

```{r}
#| label: 01-inspect-data-msoa
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect columns
ncol(msoa21)

# inspect rows
nrow(msoa21)

# inspect data
head(msoa21)

# inspect column names
names(msoa21)
```

We can also establish the class of our data:

```{r}
#| label: 01-class-data-msoa
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect
class(msoa21)
``` 

We should see our data is an `sf` dataframe, which is what we want and we can move on.

### Joining attribute data
Now we have our dataset containing London's European born population and the MSOA spatial boundaries loaded, we can join these together using an **Attribute Join**. Before proceeding with the join, we need to verify that a matching unique identifier exists in both datasets. Let's look at the column names in our datasets again:

```{r}
#| label: 01-names-att-join
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect column names
names(msoa21)

# inspect column names
names(msoa_eur)
``` 

The `msoa21cd` columns looks promising as it features in both datasets. We can quickly sort both columns and have a peek at the data:

```{r}
#| label: 01-sort-att-join
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect spatial dataset
head(sort(msoa21$msoa21cd))

# inspect attribute dataset
head(sort(msoa_eur$msoa21cd))
``` 

They seem to contain similar values, so that is promising. Let us try to join the attribute data onto the spatial data:

```{r}
#| label: 01-join-att
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: False
#| filename: "R code"
# join attribute data onto spatial data
msoa21 <- msoa21 |> 
  left_join(msoa_eur, by = c("msoa21cd" = "msoa21cd"))
``` 

::: {.callout-note}
The code above uses a pipe function: `|>`. The pipe operator allows you to pass the output of one function directly into the next, streamlining your code. While it might be a bit confusing at first, you will find that it makes your code faster to write and easier to read. More importantly, it reduces the need to create multiple intermediate variables to store outputs.
:::

We can explore the joined data in usual fashion:

```{r}
#| label: 01-inspect-join
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect columns
ncol(msoa21)

# inspect rows
nrow(msoa21)

# inspect data
head(msoa21)

# inspect column names
names(msoa21)
```

Always inspect your join to ensure everything looks as expected. A good way to do this is by using the `View()` function to check for any unexpected missing values, which are marked as `NA`. 

We can further compare the total number of rows in the spatial dataset with the total number of non-`NA` values in the joined columns:

```{r}
#| label: 01-inspect-na
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# inspect
nrow(msoa21)

# check for missing values
sum(!is.na(msoa21$eur21))

# check for missing values
sum(!is.na(msoa21$pop21))
```

No missing values. In this case we did not expect any missing values, so this confirms that all our full attribute dataset has been linked to the spatial dataset. 

We are almost ready to map the data. Only thing that is left is for us to calculate the share of European-born immigrants within each MSOA:

```{r}
#| label: 01-european-prop
#| classes: styled-output
#| echo: True
#| eval: True
#| tidy: True
#| filename: "R code"
# calculate proportion
msoa21 <- msoa21 |>
  mutate(prop_eur21 = eur21 / pop21)
```
